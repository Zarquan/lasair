import sys
import math
import json
import numpy
import healpy
from colorsys import hsv_to_rgb
import matplotlib
matplotlib.use('Agg') # switch to agg to suppress plotting windows 
import matplotlib.pyplot as plt

radian = 180/numpy.pi

def get_md(file):
    tok = file.split('/')
    filename = tok[-1]
    skymapID = filename.split('.')[0]
    return skymapID.lower()

def splitPaths(path):
    paths = []
    d = 0.0
    first = path[0]
    q = first
    newpath = []
    for p in path:
        d += abs(p[0]-q[0]) + abs(p[1]-q[1])
        q = p
        if d > 30:
            newpath.append([p[0],p[1]])
            paths.append(newpath)
            newpath = []
            d = 0.0
        newpath.append([p[0],p[1]])
    paths.append(newpath)
    return paths

def makeFile(infile, outfile, language='json'):
    print "From ", infile, " to ", outfile
    s = generate_from_fitsfile(infile, language)

    f= open(outfile, 'w')
    print>>f, s
    f.close()
    return 1

def generate_from_fitsfile(filename, language):
    healpix_data,header = healpy.read_map(filename, h=True)
    try:
        healpix_data, distmu, distsigma, distnorm = healpy.read_map(filename, field=[0, 1, 2, 3])
        dim = 3
    except:
        dim = 2

    print "dimension = %d" % dim
    if dim == 3:
        ii = (~numpy.isinf(distmu)) & (distmu > 0.0)
        print "good percent %.2f" % (numpy.sum(ii)*100.0/len(distmu))
        dm = distmu[ii]
        prob = healpix_data[ii]
        x = numpy.multiply(prob,dm)
        print "Average distance %.2f " % (numpy.sum(x)/numpy.sum(prob))

    wanted = ['DATE', 'DATE-OBS', 'INSTRUME', 'MJD-OBS', 'DISTMEAN', 'DISTSTD', 'REFERENC']
    meta = {}
    for (k,v) in header:
        if k in wanted:
            meta[k] = v

    print "Generating contours..."
    skymapID = get_md(filename)

    contours = []
    levels = []
    deciles = []
    percentile = numpy.linspace(0.9, 0.1, 9)
    for p in percentile:
        (level, area) = get_level(healpix_data, p)
        levels.append(level)
        deciles.append([p*100, area])
    meta['deciles'] = deciles
    
#    for l in levels: print l

# make latitude histogram
    nside = healpy.get_nside(healpix_data)
    allipix = numpy.arange(0, len(healpix_data))
    (th, ph) = healpy.pix2ang(nside, allipix)

    h = []
    for i in range(len(healpix_data)):
        if healpix_data[i] > levels[2]:
            ira  = int(ph[i]*radian/5.0)
            idec = int(th[i]*radian/5.0)
            pair = [ira, idec]
            if pair not in h:
                h.append(pair)

    print h
    meta['histogram'] = h

    
    ngrid = 800
#    if len(sys.argv) >= 3:
#        ngrid = int(sys.argv[2])
    
    apointRA = -999;
    apointDec = -999;
    theta = numpy.linspace(0, numpy.pi, ngrid)
    phi = numpy.linspace(0, 2*numpy.pi, 2*ngrid)
    p,t = numpy.meshgrid(phi, theta)
    data_interpolated_to_grid = healpy.pixelfunc.get_interp_val(healpix_data, t, p)
    contourplot = plt.contour(p, t, data_interpolated_to_grid, levels=levels)
    numcontours = 0
    contours = []
    for n, c in enumerate(contourplot.collections):
        color = hsv2rgb(n * 1.0 / len(levels), 1.0, 1.0)
        for contourPath, path in enumerate(c.get_paths()):
            plist = []
            for v in path.vertices:
                plist.append([v[0]*radian, 90-v[1]*radian])
            spaths = splitPaths(plist)
            for sp in spaths:
                contours.append({"name":"%d-percentile"%((n+1)*10), "color":color, "coords":sp})
#            contours.append({"name":"%d-percentile"%((n+1)*10), "color":color, "coords":plist})
                numcontours+=1
                if apointRA == -999:
                    apointRA = sp[0][0]
                    apointDec = sp[0][1]
    print "made %d polylines" % numcontours
    meta['apointRA'] = apointRA
    meta['apointDec'] = apointDec

    print "Language = ",language
    return make_json(meta, contours)

def make_json(meta, contours):
    print "building json"
    return json.dumps({"meta":meta, "contours":contours})

def get_level(m, p):
    whole_sky = radian*radian*4*numpy.pi
    ms = numpy.sort(m, axis=None)
    mr = ms[::-1]

    sum = 0.0
    i = 0
    while sum < p and i < len(mr):
        sum += mr[i]
        i += 1
    if i == 0: return 0.0
    level = mr[i - 1]
    area = i*whole_sky/len(mr)
    return (level, area)

def hsv2rgb(h, s, v):
    r, g, b = hsv_to_rgb(h, s, v)
    r = int(r * 255)
    g = int(g * 255)
    b = int(b * 255)
    return "%02x%02x%02x" % (r, g, b)

if __name__ == "__main__":
    import os, sys
    if len(sys.argv) < 2:
        print "Usage: python skymapInfo.py fitsfiles"
        sys.exit()

    infile = sys.argv[1]
    if os.path.isfile(infile):   # single file .../fits/name/123.fits --> .../json/name/123.json
        outfile = infile.replace('fits.gz', 'json').replace('fits','json')
        if outfile == infile: 
            outfile = infile.replace('fits', 'json')
        makeFile(infile, outfile, 'json')

    if os.path.isdir(infile):   # whole collection .../fits/name/123.fits --> .../json/name/123.json
        print "directory"
        tok = infile.split('/')
        if tok[-2] == 'fits':
            collection = tok[-1]
        for file in os.listdir(infile):
            name = file.replace('.fits.gz', '').replace('.fits', '')
            makeFile(infile+'/'+file, infile.replace('fits','json') +'/'+ name + '.json', 'json')
